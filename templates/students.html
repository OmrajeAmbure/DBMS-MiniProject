{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Students</h3>
  <a href="{{ url_for('add_student_ui') }}" class="btn btn-primary">+ Add Student</a>
</div>

<div id="students-table">Loading...</div>

<script>
async function loadStudents() {
  const res = await fetch('/api/students', { credentials: 'same-origin' });
  if (!res.ok) {
    document.getElementById('students-table').innerHTML = '<div class="alert alert-danger">Failed to load students. Please login.</div>';
    return;
  }
  const rows = await res.json();
  if (!Array.isArray(rows) || rows.length === 0) {
    document.getElementById('students-table').innerHTML = '<p>No students yet.</p>';
    return;
  }
  let html = '<div class="table-responsive"><table class="table table-bordered"><thead class="table-light"><tr><th>ID</th><th>Name</th><th>Roll No</th><th>Email</th><th>Phone</th><th>UT1</th><th>UT2</th><th>Created By</th><th>Actions</th></tr></thead><tbody>';
  for (const s of rows) {
    html += `<tr>
      <td>${s.id}</td>
      <td>${s.name}</td>
      <td>${s.rollno}</td>
      <td>${s.email}</td>
      <td>${s.phone || ''}</td>
      <td>${s.unit_test1_marks ?? ''}</td>
      <td>${s.unit_test2_marks ?? ''}</td>
      <td>${s.created_by ?? ''}</td>
      <td>
        <a class="btn btn-sm btn-outline-success me-1" href="/edit-student-ui/${s.id}">Edit</a>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${s.id})">Delete</button>
      </td>
    </tr>`;
  }
  html += '</tbody></table></div>';
  document.getElementById('students-table').innerHTML = html;
}

async function deleteStudent(id) {
  if (!confirm('Delete this student?')) return;
  const res = await fetch('/api/students/' + id, { method: 'DELETE', credentials: 'same-origin' });
  if (res.ok) {
    loadStudents();
  } else {
    const j = await res.json();
    alert(j.msg || 'Failed to delete');
  }
}

loadStudents();
</script>
{% endblock %}